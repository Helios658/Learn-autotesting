stages:
  - test

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  CHROME_BIN: "/usr/bin/chromium"
  CHROMEDRIVER_PATH: "/usr/bin/chromedriver"
  # –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è —Ç–µ—Å—Ç–æ–≤
  CI: "true"
  TEST_BASE_URL: "https://gamma.hi-tech.org"
  HEADLESS_MODE: "true"
  BROWSER: "chrome"
  TEST_USER_EMAIL: "v.kornienko@iva.ru"
  # –î–æ–±–∞–≤–ª—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è Docker
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""

cache:
  paths:
    - .cache/pip

full_e2e_tests:
  stage: test
  image: python:3.11.14-slim-bullseye
  tags:
    - docker_last
  retry:
    max: 2
    when:
      - runner_system_failure
      - stuck_or_timeout_failure
  before_script:
    # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ —Å —É–≤–µ–ª–∏—á–µ–Ω–Ω—ã–º —Ç–∞–π–º–∞—É—Ç–æ–º
    - apt-get update -o Acquire::http::Timeout=60 -o Acquire::ftp::Timeout=60
    - apt-get install -y --no-install-recommends 
      chromium 
      chromium-driver 
      ca-certificates 
      curl
    - python -m pip install --upgrade pip
    - pip install --retries 5 --timeout 60 -r requirements.txt
    - chromium --version
    - chromedriver --version
    - export TEST_USER_PASSWORD="${TEST_USER_PASSWORD}"
    - echo "${TEST_USER_PASSWORD}" > last_generated_password.txt || true

  script:
    - pytest -v --headless --junitxml=report.xml

  after_script:
    - echo "‚úÖ –¢–µ—Å—Ç—ã –∑–∞–≤–µ—Ä—à–µ–Ω—ã"
    - echo "üìù –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π –ø–∞—Ä–æ–ª—å: $(cat last_generated_password.txt 2>/dev/null || echo '–Ω–µ —Å–æ–∑–¥–∞–Ω')"
    
  artifacts:
    when: always
    expire_in: 7 days
    reports:
      junit: report.xml
    paths:
      - report.xml
      - .pytest_cache
      - last_generated_password.txt